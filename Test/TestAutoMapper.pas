unit TestAutoMapper;
{

  Delphi DUnit Test Case
  ----------------------
  This unit contains a skeleton test case class generated by the Test Case Wizard.
  Modify the generated code to correctly setup and call the methods from the unit 
  being tested.

}

interface

uses
  TestFramework,
  Test.Models,
  AutoMapper.Mapper,
  AutoMapper.ConfigurationProvider,
  Spring,
  Spring.Collections,
  AutoMapper.ClassPair
  ;

type

  TestTMapper = class(TTestCase)
  strict private
    FLastName   : string;
    FFirstName  : string;
    FMiddleName : string;
    FAge        : integer;
    FFullName   : string;
    FMapper: TMapper;
    procedure _Configure;
  public
    procedure SetUp; override;
    procedure TearDown; override;
  published
    procedure TestConfigure;
    procedure TestMap_params_2;
    procedure TestMap_params_1;
    procedure TestMap_WithConstructor;
  end;

implementation


procedure TestTMapper.SetUp;
begin
  FLastName   := 'Иванов';
  FFirstName  := 'Сергей';
  FMiddleName := 'Николаеивч';
  FAge        :=  26;
  FFullName := FLastName+' '+FFirstName+' '+FMiddleName;
  FMapper := Mapper;
end;

procedure TestTMapper.TearDown;
begin
//  FMapper.Free;
end;

procedure TestTMapper.TestConfigure;
begin
  _configure;
end;

procedure TestTMapper.TestMap_params_1;
var
  FPerson:    TPerson;
  FUserDTO:   TUserDTO;
  FPersonDTO: TPersonDTO;
begin
  _configure;

  FPerson := TPerson.Create(FLastName, FFirstName, FMiddleName, FAge);

  FUserDTO    := Mapper.Map<TUserDTO>(FPerson);
  FPersonDTO  := Mapper.Map<TPersonDTO>(FPerson);

  CheckEquals(FFullName,    FUserDTO.FullName);
  CheckEquals(FAge,         FUserDTO.Age);
  CheckEquals(FLastName,    FPersonDTO.LastName);
  CheckEquals(FFirstName,   FPersonDTO.FirstName);
  CheckEquals(FMiddleName,  FPerson.MiddleName);
  CheckEquals(FAge,         FPerson.Age);
end;

procedure TestTMapper.TestMap_params_2;
var
  FPerson:    TPerson;
  FUserDTO:   TUserDTO;
  FPersonDTO: TPersonDTO;

begin
  _configure;

  FPerson := TPerson.Create(FLastName, FFirstName, FMiddleName, FAge);

  FUserDTO    := Mapper.Map<TPerson, TUserDTO>(FPerson);
  FPersonDTO  := Mapper.Map<TPerson, TPersonDTO>(FPerson);

  CheckEquals(FFullName,    FUserDTO.FullName);
  CheckEquals(FAge,         FUserDTO.Age);
  CheckEquals(FLastName,    FPersonDTO.LastName);
  CheckEquals(FFirstName,   FPersonDTO.FirstName);
  CheckEquals(FMiddleName,  FPersonDTO.MiddleName);
  CheckEquals(FAge,         FPersonDTO.Age,
              'В исходном объекте свойство Age: Nullabe<integer>, а в результатирующем Age: integer. Автоматический Cast стандартными средствами не возможен');
end;

procedure TestTMapper.TestMap_WithConstructor;
 var
  FPerson:    TPerson;
  FPersonDTO: TPersonDTO;
begin
  _configure;

  FPersonDTO := TPersonDTO.Create;
  FPersonDTO.Age        := FAge;
  FPersonDTO.LastName   := FLastName;
  FPersonDTO.FirstName  := FFirstName;
  FPersonDTO.MiddleName := FMiddleName;

  FPerson := mapper.Map<TPerson>(FPersonDTO);

  CheckEquals(FLastName,    FPerson.LastName);
  CheckEquals(FFirstName,   FPerson.FirstName);
  CheckEquals(FMiddleName,  FPerson.MiddleName);
  CheckEquals(FAge,         FPerson.Age);
end;

procedure TestTMapper._Configure;
begin
  Mapper.Reset;
  Mapper.Configure(procedure (const cfg: TConfigurationProvider)
                  begin
                    cfg.CreateMap<TPerson, TUserDTO>(procedure (const FPerson: TPerson; out FUserDTO: TUserDTO)
                                                        begin
                                                          FUserDTO.FullName := FPerson.LastName    +' '+
                                                                               FPerson.FirstName   +' '+
                                                                               FPerson.MiddleName;

                                                          FUserDTO.Age      := FPerson.Age;
                                                        end
                                                      )
                       .CreateMap<TPersonDTO, TPerson>(procedure (const FPersonDTO: TPersonDTO; out FPerson: TPerson)
                                                        begin
                                                          FPerson := TPerson.Create(FPersonDTO.LastName,
                                                                                    FPersonDTO.FirstName,
                                                                                    FPersonDTO.MiddleName,
                                                                                    FPersonDTO.Age);
                                                        end
                                                      )
                       .CreateMap<TPerson, TPersonDTO>();
                  end);
end;

initialization
  // Register any test cases with the test runner
  RegisterTest(TestTMapper.Suite);
end.

